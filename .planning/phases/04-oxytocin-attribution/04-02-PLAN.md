---
phase: 04-oxytocin-attribution
plan: 02
type: execute
---

<objective>
Build reciprocity dashboard showing give/receive balance and optional gratitude prompts.

Purpose: Surface the bidirectional nature of community contribution, reinforcing oxytocin through visible reciprocity.
Output: Reciprocity card in Profile/Progress showing give vs receive, optional gratitude prompts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-oxytocin-attribution/04-01-SUMMARY.md
@src/lib/voice.ts (already tracks given vs received validation)
@src/components/Profile.tsx
@src/components/VoiceDetailModal.tsx

**Existing Voice components:**
- Validation Received: Karma, saves by others, completions
- Validation Given: Karma given, saves made, completions performed

**Goal:** Surface this as explicit "give/receive" balance, add gratitude prompt.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReciprocityCard component</name>
  <files>src/components/ReciprocityCard.tsx</files>
  <action>
Create a card showing give/receive balance:

```tsx
/**
 * ReciprocityCard - Shows community give/receive balance
 *
 * Visualizes:
 * - What you've received (upvotes, saves, completions on your content)
 * - What you've given (upvotes, saves, completions of others' content)
 * - Balance indicator (generous / balanced / could give more)
 *
 * Oxytocin trigger: Seeing the mutual flow of community support
 */

import { Card, CardHeader, CardBody } from '@/components/Card'

interface ReciprocityData {
  received: {
    karma: number
    saves: number
    completions: number
  }
  given: {
    karma: number
    saves: number
    completions: number
  }
}

export function ReciprocityCard({ data }: { data: ReciprocityData }) {
  const receivedTotal = data.received.karma + data.received.saves + data.received.completions
  const givenTotal = data.given.karma + data.given.saves + data.given.completions

  const ratio = givenTotal / Math.max(receivedTotal, 1)
  const balance = ratio >= 1.2 ? 'generous' : ratio >= 0.8 ? 'balanced' : 'receiver'

  const balanceMessages = {
    generous: 'You give more than you receive',
    balanced: 'Beautiful balance of give and take',
    receiver: 'The community is supporting you'
  }

  return (
    <Card>
      <CardHeader
        title="Community Flow"
        description="Your give and receive with the community"
      />
      <CardBody>
        <div className="grid grid-cols-2 gap-4">
          {/* Given */}
          <div className="text-center">
            <p className="text-2xl font-medium text-accent">{givenTotal}</p>
            <p className="text-xs text-ink-soft">Given</p>
            <p className="text-xs text-ink-soft/60 mt-1">
              {data.given.karma} votes ¬∑ {data.given.saves} saves
            </p>
          </div>

          {/* Received */}
          <div className="text-center">
            <p className="text-2xl font-medium text-ink">{receivedTotal}</p>
            <p className="text-xs text-ink-soft">Received</p>
            <p className="text-xs text-ink-soft/60 mt-1">
              {data.received.karma} votes ¬∑ {data.received.saves} saves
            </p>
          </div>
        </div>

        {/* Balance message */}
        <p className="text-center text-sm text-ink-soft mt-4 italic">
          {balanceMessages[balance]}
        </p>
      </CardBody>
    </Card>
  )
}
```

No judgment language - all states are positive (generous, balanced, receiving support).
  </action>
  <verify>Component renders with give/receive data</verify>
  <done>ReciprocityCard component created</done>
</task>

<task type="auto">
  <name>Task 2: Add reciprocity data fetching</name>
  <files>src/lib/reciprocity.ts</files>
  <action>
Create service to fetch reciprocity data (can use existing voice.ts data):

```typescript
import { getVoiceInputs } from './voice'

export interface ReciprocityData {
  received: {
    karma: number
    saves: number
    completions: number
  }
  given: {
    karma: number
    saves: number
    completions: number
  }
}

export async function getReciprocityData(userId: string): Promise<ReciprocityData> {
  const voiceInputs = await getVoiceInputs(userId)

  return {
    received: {
      karma: voiceInputs.karmaReceived,
      saves: voiceInputs.contentSavedByOthers,
      completions: voiceInputs.templateCompletions
    },
    given: {
      karma: voiceInputs.karmaGiven,
      saves: voiceInputs.savesMade,
      completions: voiceInputs.completionsDone
    }
  }
}
```

Reuse existing voice calculation inputs rather than duplicating queries.
  </action>
  <verify>Data matches what's shown in VoiceDetailModal</verify>
  <done>Reciprocity data fetching implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add gratitude prompt after practicing others' meditations</name>
  <files>src/components/InsightCapture.tsx</files>
  <action>
Add optional gratitude prompt when completing someone else's meditation:

```tsx
// After session complete, if the session was from a community template:
{session.templateId && session.templateCreatorId !== currentUserId && (
  <div className="mt-4 p-3 bg-accent-muted/50 rounded-lg">
    <p className="text-sm text-ink-soft text-center">
      This meditation was created by a community member.
    </p>
    <button
      onClick={sendAnonymousAppreciation}
      className="mt-2 w-full py-2 text-sm text-accent"
    >
      Send anonymous appreciation üíù
    </button>
  </div>
)}

// Handler:
const sendAnonymousAppreciation = async () => {
  // Increment appreciation count on template (anonymous, no user tracking)
  await supabase
    .from('session_templates')
    .update({ appreciation_count: supabase.raw('appreciation_count + 1') })
    .eq('id', session.templateId)

  tapFeedback.success()
  setAppreciationSent(true)
}
```

Appreciation is anonymous - no social pressure, just gratitude.
One-time prompt per session, non-intrusive placement.
  </action>
  <verify>Gratitude prompt appears after community meditation, sends appreciation</verify>
  <done>Anonymous gratitude prompt added</done>
</task>

<task type="auto">
  <name>Task 4: Wire ReciprocityCard into Profile/Progress</name>
  <files>src/components/Profile.tsx</files>
  <action>
Add ReciprocityCard to user profile:

```tsx
import { ReciprocityCard } from '@/components/ReciprocityCard'
import { getReciprocityData } from '@/lib/reciprocity'

// In component:
const [reciprocityData, setReciprocityData] = useState<ReciprocityData | null>(null)

useEffect(() => {
  if (user) {
    getReciprocityData(user.id).then(setReciprocityData)
  }
}, [user])

// In render, after other profile cards:
{reciprocityData && <ReciprocityCard data={reciprocityData} />}
```

Place below VoiceDetailModal trigger for related context.
  </action>
  <verify>ReciprocityCard appears in Profile with user's data</verify>
  <done>ReciprocityCard integrated into Profile</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Reciprocity dashboard and gratitude prompt</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Go to Profile tab
    3. Verify: ReciprocityCard shows give/receive numbers
    4. Verify: Balance message is positive (not judgmental)
    5. Practice a community meditation (from Explore tab)
    6. After completion, verify: Gratitude prompt appears
    7. Tap "Send appreciation"
    8. Verify: Haptic feedback, button changes to "Sent"
    9. Verify: No spam - prompt only shows once per session
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] ReciprocityCard shows in Profile
- [ ] Give/receive numbers are accurate
- [ ] Balance messaging is positive
- [ ] Gratitude prompt appears for community meditations
- [ ] Anonymous appreciation works
- [ ] Phase 04 complete
</verification>

<success_criteria>

- All tasks completed
- Reciprocity visible to users
- Gratitude flows between community members
- Oxytocin triggers through visible mutual support
</success_criteria>

<output>
After completion, create `.planning/phases/04-oxytocin-attribution/04-02-SUMMARY.md`
</output>
