---
phase: 04-oxytocin-attribution
plan: 01
type: execute
---

<objective>
Build attribution tracking to show users when their content helps others.

Purpose: Trigger oxytocin through visible evidence of positive impact - "Your meditation helped 3 people this week."
Output: Attribution tracking system, "your impact" notifications.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-gentle-reminders/07-01-SUMMARY.md (notifications infrastructure)
@src/lib/db.ts
@src/lib/notifications.ts
@src/lib/templates.ts
@src/lib/pearls.ts

**Attribution events:**
- Someone practices your meditation template
- Someone saves your pearl
- Someone upvotes your content

**Trigger mechanism:**
- Track completions/saves/votes on user's content
- Aggregate over time period (weekly)
- Generate attribution notification if count > 0
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create attribution tracking service</name>
  <files>src/lib/attribution.ts</files>
  <action>
Create service to track and aggregate attribution data:

```typescript
/**
 * Attribution Tracking
 *
 * Tracks how a user's contributions help others:
 * - Template completions by others
 * - Pearl saves by others
 * - Upvotes received
 *
 * Generates oxytocin-triggering notifications:
 * "Your meditation helped 3 people this week"
 */

import { db } from './db'
import { addNotification } from './notifications'

export interface AttributionStats {
  templateCompletions: number  // How many completed your meditations
  pearlSaves: number           // How many saved your pearls
  upvotesReceived: number      // Karma received
  timeframe: 'today' | 'week' | 'month'
}

export async function getAttributionStats(
  userId: string,
  timeframe: 'today' | 'week' | 'month' = 'week'
): Promise<AttributionStats> {
  const startDate = getStartDate(timeframe)

  // Query Supabase for completions of user's templates
  const { data: completions } = await supabase
    .from('session_completions')
    .select('template_id, created_at')
    .in('template_id', userTemplateIds)
    .gte('created_at', startDate.toISOString())
    .neq('user_id', userId)  // Exclude self

  // Query pearl saves
  const { data: saves } = await supabase
    .from('pearl_saves')
    .select('pearl_id, created_at')
    .in('pearl_id', userPearlIds)
    .gte('created_at', startDate.toISOString())
    .neq('user_id', userId)

  // Query upvotes
  const { data: votes } = await supabase
    .from('session_template_votes')
    .select('template_id, created_at')
    .in('template_id', userTemplateIds)
    .gte('created_at', startDate.toISOString())
    .neq('user_id', userId)

  return {
    templateCompletions: completions?.length || 0,
    pearlSaves: saves?.length || 0,
    upvotesReceived: votes?.length || 0,
    timeframe
  }
}

function getStartDate(timeframe: string): Date {
  const now = new Date()
  switch (timeframe) {
    case 'today':
      return new Date(now.setHours(0, 0, 0, 0))
    case 'week':
      const weekStart = new Date(now)
      weekStart.setDate(now.getDate() - now.getDay())
      weekStart.setHours(0, 0, 0, 0)
      return weekStart
    case 'month':
      return new Date(now.getFullYear(), now.getMonth(), 1)
    default:
      return new Date(now.setDate(now.getDate() - 7))
  }
}
```

Note: Requires userId context - integrate with auth.
  </action>
  <verify>Attribution stats query returns correct counts</verify>
  <done>Attribution tracking service created</done>
</task>

<task type="auto">
  <name>Task 2: Create attribution notification generator</name>
  <files>src/lib/attribution.ts</files>
  <action>
Add function to generate attribution notifications:

```typescript
export async function generateAttributionNotification(
  userId: string
): Promise<void> {
  const stats = await getAttributionStats(userId, 'week')

  // Only generate if there's positive impact
  const totalImpact = stats.templateCompletions + stats.pearlSaves

  if (totalImpact === 0) return

  // Build notification message
  let title = ''
  let body = ''

  if (stats.templateCompletions > 0 && stats.pearlSaves > 0) {
    title = 'Your wisdom is spreading'
    body = `${stats.templateCompletions} people practiced your meditations and ${stats.pearlSaves} saved your pearls this week.`
  } else if (stats.templateCompletions > 0) {
    title = 'You helped someone meditate'
    body = `${stats.templateCompletions} ${stats.templateCompletions === 1 ? 'person' : 'people'} practiced your meditation${stats.templateCompletions === 1 ? '' : 's'} this week.`
  } else {
    title = 'Your pearl resonated'
    body = `${stats.pearlSaves} ${stats.pearlSaves === 1 ? 'person' : 'people'} saved your pearl${stats.pearlSaves === 1 ? '' : 's'} this week.`
  }

  await addNotification({
    id: `attribution-${Date.now()}`,
    type: 'attribution',
    title,
    body,
    createdAt: new Date(),
    metadata: {
      helpedCount: totalImpact,
      timeframe: 'this week'
    }
  })
}
```

Language is warm and personal - "You helped someone", not "3 users engaged with your content."
  </action>
  <verify>Notification generated with warm language</verify>
  <done>Attribution notification generator created</done>
</task>

<task type="auto">
  <name>Task 3: Schedule weekly attribution check</name>
  <files>src/App.tsx</files>
  <action>
Add periodic check for attribution updates:

```typescript
// In App.tsx or appropriate initialization file

import { generateAttributionNotification } from '@/lib/attribution'
import { useAuth } from '@/lib/auth'

// In useEffect on app load:
useEffect(() => {
  const checkAttribution = async () => {
    if (!user) return

    // Check if we've already notified this week
    const lastCheck = localStorage.getItem('lastAttributionCheck')
    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000)

    if (!lastCheck || parseInt(lastCheck) < weekAgo) {
      await generateAttributionNotification(user.id)
      localStorage.setItem('lastAttributionCheck', Date.now().toString())
    }
  }

  // Delay to not block initial load
  const timeout = setTimeout(checkAttribution, 5000)
  return () => clearTimeout(timeout)
}, [user])
```

Weekly check, not every session - avoids notification fatigue.
  </action>
  <verify>Attribution check runs once per week</verify>
  <done>Weekly attribution check scheduled</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Attribution stats query works
- [ ] Notifications generated with warm language
- [ ] Weekly check doesn't spam (once per week max)
- [ ] Respects notification preferences
</verification>

<success_criteria>

- All tasks completed
- Users see impact of their contributions
- Language is warm and personal
- Oxytocin pathway activated through attribution
</success_criteria>

<output>
After completion, create `.planning/phases/04-oxytocin-attribution/04-01-SUMMARY.md`
</output>
