---
phase: 10-hour-bank-depletion
plan: 01
type: execute
---

<objective>
Implement hour bank depletion logic with deficit carry-forward and low hours warning system.

Purpose: Prevent users from gaming the hour bank system (e.g., starting sessions with 1 minute left and meditating for an hour free) while maintaining a positive UX that encourages top-up at the right moments.

Output:

- Deficit is tracked when consumed > purchased
- Deficit carries forward to next purchase (not forgiven)
- Low hours warnings appear at strategic moments
- Dev tools for testing hour bank states
  </objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
**Key files:**
@src/lib/hourBank.ts - Hour bank CRUD and calculations
@src/stores/useHourBankStore.ts - Hour bank state management
@src/components/Timer.tsx - Main timer with paywall trigger
@src/components/Paywall.tsx - Purchase modal
@src/components/Store.tsx - Full store page
@src/components/Settings.tsx - Dev tools location

**Bug identified:**
In `addPurchasedHours()` (line 161), the deficit was being forgiven:

```typescript
availableHours: hourBank.availableHours + hours // BUG: ignores deficit
```

Should be:

```typescript
const newAvailable = Math.max(0, newTotalPurchased - hourBank.totalConsumedHours)
```

**Design decisions:**

1. **Deficit Policy**: Carry forward (strict accounting)
   - Cumulative meditation time always records fully
   - But deficit deducted from next purchase

2. **Warning System**: Two-tier
   - Under 1 hour: Hint text on timer ("47m remaining · tap to meditate")
   - Under 30 minutes: Modal warning before timer starts

3. **Deficit Message**: Show on paywall and store page
   </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix deficit accounting in hourBank.ts</name>
  <files>src/lib/hourBank.ts</files>
  <action>
1. Fix `addPurchasedHours()` to calculate available hours properly:
   - `newAvailable = Math.max(0, newTotalPurchased - totalConsumedHours)`
2. Update `getHourBalance()` return type to include `deficit` field
3. Calculate deficit as `Math.max(0, totalConsumedHours - totalPurchasedHours)`
  </action>
  <verify>
- TypeScript compiles
- `getHourBalance()` returns deficit
  </verify>
  <done>
- `addPurchasedHours()` carries forward deficit
- `getHourBalance()` includes deficit calculation
  </done>
</task>

<task type="auto">
  <name>Task 2: Expose deficit & low hours state in store</name>
  <files>src/stores/useHourBankStore.ts</files>
  <action>
Add new state fields to HourBankState interface:
- `deficit: number` - Hours owed (0 if none)
- `isLowHours: boolean` - true if available < 1h
- `isCriticallyLow: boolean` - true if available < 30m and > 0

Update `hydrate()` and `refreshBalance()` to compute these flags.
</action>
<verify>

- Store exposes deficit, isLowHours, isCriticallyLow
  </verify>
  <done>
- State fields added
- Computed on hydrate and refresh
  </done>
  </task>

<task type="auto">
  <name>Task 3: Add low hours hint to Timer</name>
  <files>src/components/Timer.tsx</files>
  <action>
1. Import `formatHours` from hourBank
2. Destructure `isLowHours`, `isCriticallyLow`, `available` from store
3. Update resting hint: when `isLowHours && available > 0`, show "47m remaining · tap to meditate"
4. Update `handleStart` to show warning modal when `isCriticallyLow`
  </action>
  <verify>
- With < 1h remaining, hint shows "Xm remaining · tap to meditate"
  </verify>
  <done>
- Low hours hint implemented
- Critical check in handleStart
  </done>
</task>

<task type="auto">
  <name>Task 4: Create LowHoursWarning modal</name>
  <files>src/components/LowHoursWarning.tsx (new)</files>
  <action>
Create modal component that:
- Shows when user taps to start with < 30 minutes remaining
- Title: "Running Low"
- Message: "You have Xm remaining. Top up now to avoid losing meditation time to deficit."
- Buttons: "Continue" (proceeds with session) | "Top Up" (opens paywall)
  </action>
  <verify>
- Modal renders with correct content
- Continue proceeds with session
- Top Up opens paywall
  </verify>
  <done>
- LowHoursWarning.tsx created
- Integrated in Timer.tsx
  </done>
</task>

<task type="auto">
  <name>Task 5: Update Paywall with deficit message</name>
  <files>src/components/Paywall.tsx</files>
  <action>
1. Destructure `deficit` from store
2. When deficit > 0, show: "Xm will be applied to your next purchase."
  </action>
  <verify>
- With deficit, message appears below header
  </verify>
  <done>
- Deficit message shown on paywall
  </done>
</task>

<task type="auto">
  <name>Task 6: Update Store with deficit display</name>
  <files>src/components/Store.tsx</files>
  <action>
1. Destructure `deficit` from store
2. When deficit > 0, show info box:
   - "Previous session overage: Xm"
   - "This will be deducted from your purchase."
  </action>
  <verify>
- With deficit, info box appears below balance
  </verify>
  <done>
- Deficit info displayed on store page
  </done>
</task>

<task type="auto">
  <name>Task 7: Add dev tools for hour bank testing</name>
  <files>src/stores/useHourBankStore.ts, src/components/Settings.tsx</files>
  <action>
1. Add `devSetHourBank(purchased, consumed)` to store (dev-only)
2. Add UI in Settings Dev Tools section:
   - Display current state (purchased/consumed/available/deficit)
   - Input fields for manual values
   - Quick presets: Low (48m), Critical (24m), Deficit (30m owed), Full (10h), Empty
3. Add buttons to trigger ReviewPrompt for testing
  </action>
  <verify>
- Dev tools appear in Settings when in dev mode
- Presets correctly set hour bank state
  </verify>
  <done>
- devSetHourBank function added
- Settings UI for hour bank testing
- Review prompt testing buttons
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (warnings OK, no errors)
- [ ] Deficit carries forward on purchase
- [ ] Low hours hint appears on timer
- [ ] Warning modal appears at < 30m
- [ ] Deficit shown on paywall and store
- [ ] Dev tools work for testing all states
</verification>

<success_criteria>

- Deficit accounting is mathematically correct
- User experience guides toward purchase at right moments
- No interruption during active meditation
- All states testable via dev tools
  </success_criteria>

<output>
After completion, create `.planning/phases/10-hour-bank-depletion/10-01-SUMMARY.md`
</output>
