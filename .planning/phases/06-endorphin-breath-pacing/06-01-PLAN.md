---
phase: 06-endorphin-breath-pacing
plan: 01
type: execute
---

<objective>
Add optional breath pacing guides with visual and haptic synchronization.

Purpose: Deepen physical release and endorphin activation through guided breathing patterns.
Output: Breath pacing options, visual breath guide, optional haptic sync.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-haptic-vocabulary/01-01-SUMMARY.md (haptics with breatheIn/breatheOut)
@src/hooks/useTapFeedback.ts
@src/components/Timer.tsx
@src/lib/settingsStore.ts

**Breath pacing patterns:**
- 4-7-8 breathing: Inhale 4s, hold 7s, exhale 8s (relaxation)
- Box breathing: 4s each phase (focus, calm)
- Simple: 4s in, 4s out (beginners)

**Requirements:**
- Opt-in (default: no pacing - open awareness is valid)
- Visual guide (orb size changes with breath)
- Haptic sync (gentle pulse on phase transitions)
- Respects session template settings (some meditations shouldn't pace)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define breath pacing patterns</name>
  <files>src/lib/breathPacing.ts</files>
  <action>
Create breath pacing system:

```typescript
/**
 * Breath Pacing Patterns
 *
 * Optional guided breathing for endorphin activation.
 * Each pattern has phases with durations in seconds.
 */

export type BreathPhase = 'inhale' | 'hold' | 'exhale' | 'holdEmpty'

export interface BreathPattern {
  id: string
  name: string
  description: string
  phases: Array<{ phase: BreathPhase; duration: number }>
  totalCycleDuration: number  // Sum of all phases
}

export const BREATH_PATTERNS: BreathPattern[] = [
  {
    id: 'simple',
    name: 'Simple',
    description: '4 seconds in, 4 seconds out',
    phases: [
      { phase: 'inhale', duration: 4 },
      { phase: 'exhale', duration: 4 }
    ],
    totalCycleDuration: 8
  },
  {
    id: 'box',
    name: 'Box Breathing',
    description: 'Equal phases: inhale, hold, exhale, hold',
    phases: [
      { phase: 'inhale', duration: 4 },
      { phase: 'hold', duration: 4 },
      { phase: 'exhale', duration: 4 },
      { phase: 'holdEmpty', duration: 4 }
    ],
    totalCycleDuration: 16
  },
  {
    id: '478',
    name: '4-7-8 Relaxation',
    description: 'Deep relaxation pattern',
    phases: [
      { phase: 'inhale', duration: 4 },
      { phase: 'hold', duration: 7 },
      { phase: 'exhale', duration: 8 }
    ],
    totalCycleDuration: 19
  }
]

export function getBreathPattern(id: string): BreathPattern | undefined {
  return BREATH_PATTERNS.find(p => p.id === id)
}
```

Patterns are well-researched, not arbitrary.
  </action>
  <verify>Patterns have correct total durations</verify>
  <done>Breath pacing patterns defined</done>
</task>

<task type="auto">
  <name>Task 2: Create useBreathPacing hook</name>
  <files>src/hooks/useBreathPacing.ts</files>
  <action>
Create hook to manage breath pacing state:

```typescript
import { useState, useEffect, useCallback, useRef } from 'react'
import { BreathPattern, BreathPhase } from '@/lib/breathPacing'
import { useTapFeedback } from '@/hooks/useTapFeedback'
import { useSettings } from '@/lib/settingsStore'

interface BreathPacingState {
  phase: BreathPhase
  progress: number  // 0-1 within current phase
  phaseTimeRemaining: number
  cycleCount: number
}

export function useBreathPacing(pattern: BreathPattern | null, isActive: boolean) {
  const [state, setState] = useState<BreathPacingState | null>(null)
  const { breathHapticsEnabled } = useSettings()
  const tapFeedback = useTapFeedback()
  const intervalRef = useRef<number | null>(null)
  const phaseIndexRef = useRef(0)
  const phaseTimeRef = useRef(0)

  useEffect(() => {
    if (!pattern || !isActive) {
      setState(null)
      return
    }

    // Start breath pacing
    const tick = () => {
      const currentPhaseIndex = phaseIndexRef.current
      const currentPhase = pattern.phases[currentPhaseIndex]

      phaseTimeRef.current += 0.1  // 100ms ticks

      if (phaseTimeRef.current >= currentPhase.duration) {
        // Move to next phase
        phaseTimeRef.current = 0
        phaseIndexRef.current = (currentPhaseIndex + 1) % pattern.phases.length

        // Haptic feedback on phase transition
        if (breathHapticsEnabled) {
          const nextPhase = pattern.phases[phaseIndexRef.current]
          if (nextPhase.phase === 'inhale') {
            tapFeedback.breatheIn()
          } else if (nextPhase.phase === 'exhale') {
            tapFeedback.breatheOut()
          }
        }
      }

      const phase = pattern.phases[phaseIndexRef.current]
      setState({
        phase: phase.phase,
        progress: phaseTimeRef.current / phase.duration,
        phaseTimeRemaining: phase.duration - phaseTimeRef.current,
        cycleCount: Math.floor((phaseIndexRef.current + phaseTimeRef.current / phase.duration) / pattern.phases.length)
      })
    }

    intervalRef.current = window.setInterval(tick, 100)

    return () => {
      if (intervalRef.current) clearInterval(intervalRef.current)
    }
  }, [pattern, isActive, breathHapticsEnabled])

  return state
}
```

100ms tick for smooth visual updates without excessive CPU.
  </action>
  <verify>Hook tracks breath phases correctly</verify>
  <done>useBreathPacing hook created</done>
</task>

<task type="auto">
  <name>Task 3: Add breath pacing settings</name>
  <files>src/lib/settingsStore.ts, src/components/Settings.tsx</files>
  <action>
Add breath pacing preferences:

```typescript
// In settingsStore.ts:
interface Settings {
  // ... existing
  breathPacing: {
    enabled: boolean              // Show breath guide during sessions
    defaultPattern: string | null // 'simple', 'box', '478', or null
    hapticsEnabled: boolean       // Haptic feedback on phase changes
  }
}

// Defaults:
breathPacing: {
  enabled: false,        // Opt-in - open awareness is valid
  defaultPattern: null,
  hapticsEnabled: true   // If using pacing, haptics enhance it
}
```

In Settings.tsx, add section under "Session Preferences":

```tsx
<SettingSection title="Breath Pacing">
  <SettingRow
    label="Show breath guide"
    description="Visual breathing guide during meditation"
  >
    <Toggle
      checked={settings.breathPacing.enabled}
      onChange={(enabled) => setSettings({ breathPacing: { ...settings.breathPacing, enabled } })}
    />
  </SettingRow>

  {settings.breathPacing.enabled && (
    <>
      <SettingRow label="Default pattern">
        <Select
          value={settings.breathPacing.defaultPattern || 'simple'}
          options={[
            { value: 'simple', label: 'Simple (4-4)' },
            { value: 'box', label: 'Box Breathing' },
            { value: '478', label: '4-7-8 Relaxation' }
          ]}
          onChange={(value) => setSettings({ breathPacing: { ...settings.breathPacing, defaultPattern: value } })}
        />
      </SettingRow>

      <SettingRow
        label="Haptic cues"
        description="Gentle vibration on breath transitions"
      >
        <Toggle
          checked={settings.breathPacing.hapticsEnabled}
          onChange={(hapticsEnabled) => setSettings({ breathPacing: { ...settings.breathPacing, hapticsEnabled } })}
        />
      </SettingRow>
    </>
  )}
</SettingSection>
```

Settings only expand when breath pacing is enabled.
  </action>
  <verify>Settings UI shows breath pacing options</verify>
  <done>Breath pacing settings added</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] 3 breath patterns defined correctly
- [ ] useBreathPacing hook tracks state
- [ ] Settings UI shows breath options
- [ ] Default is OFF (opt-in)
</verification>

<success_criteria>

- All tasks completed
- Infrastructure ready for Timer integration
- User has full control over breath features
</success_criteria>

<output>
After completion, create `.planning/phases/06-endorphin-breath-pacing/06-01-SUMMARY.md`
</output>
