---
phase: 09-journey-planner-fixes
plan: 01
type: execute
---

<objective>
Fix dual-state session/plan handling in Journey tab calendar system.

Purpose: Allow users to plan future sessions on days that already have completed sessions, with proper visual differentiation and modal hierarchy.

Output: Working calendar planning where:

- Multiple plans per day are properly tracked
- Completed sessions don't hide future plans
- Modal opens in planning mode first, session review second
- Visual indicators distinguish planned vs completed states
  </objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@src/lib/db/plans.ts - PlannedSession CRUD (needs multiple plans per day support)
@src/components/MeditationPlanner/usePlannerState.ts - Modal state logic
@src/components/Calendar.tsx - Calendar visual indicators
@src/components/WeekStones.tsx - Week status visualization
@src/components/NextSessionSpotlight.tsx - Hero display for upcoming plans
@src/components/Journey/index.tsx - Journey tab orchestration

**Core Issues (from user screenshots and analysis):**

1. **Data model limitation**: `getPlannedSession(date)` returns only first plan, but users can have multiple plans per day
2. **Auto-linking bug**: `linkSessionToPlan()` links to ANY unlinked plan regardless of time, causing a 6:34 AM plan to get linked when completing a later session
3. **Modal hierarchy inverted**: When opening modal on a day with sessions, it defaults to session view instead of planning view
4. **Visual cues missing**: Calendar/WeekStones don't show "upcoming plan today" when session already completed
5. **NextSessionSpotlight stale**: Doesn't find plans for today if any session completed today (due to date comparison logic)

**Key design decisions:**

- Planning first, review second (modal hierarchy)
- Multiple plans per day supported
- Auto-link should match by planned time, not just date
- Visual differentiation: upcoming plans vs completed sessions
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix plan linking to respect planned time</name>
  <files>src/lib/db/plans.ts</files>
  <action>
Update `linkSessionToPlan()` to match plans by planned time, not just date:
1. When linking a session, prefer plans whose `plannedTime` is closest to the session's start time
2. Only link to plans without a `plannedTime` as fallback
3. Add `getAllPlansForDate(date)` function to return ALL plans for a date (not just first)
4. Update `getNextPlannedSession()` to find plans for today that are still upcoming (plannedTime > current time OR no time set and day not over)

The key insight: a plan for "6:34 AM" should not get auto-linked when you complete a session at "10:05 AM" - those are different meditation sessions.
</action>
<verify>

- Run `npm run build` to verify TypeScript compiles
- Manual test: Create two plans for today (morning and afternoon), complete a session, verify only the time-matching plan gets linked
  </verify>
  <done>
- `linkSessionToPlan()` prefers time-matched plans
- `getAllPlansForDate()` exists and returns all plans
- `getNextPlannedSession()` finds upcoming plans for today correctly
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update usePlannerState to show planning mode first</name>
  <files>src/components/MeditationPlanner/usePlannerState.ts</files>
  <action>
Change the modal's default behavior to prioritize planning over session review:

1. In `dayItems` computation, sort items so upcoming/incomplete plans appear BEFORE completed sessions
2. When modal opens, if there are pending plans, default `selectedItemIndex` to the first pending plan (not first session)
3. If it's a future date or today with no sessions yet, default to plan creation mode

The hierarchy should be:

- First: Incomplete/upcoming plans (user can edit before session)
- Second: Completed sessions (user can review/edit metadata)
- Add new: Always available via "+ Add Another Session"

This ensures clicking "Plan a Session" or a calendar date opens in planning context, not session review.
</action>
<verify>

- Open modal on today (which has sessions): should show planning form first if there's a pending plan
- Open modal on today with no pending plans but has sessions: should show sessions
- Open modal on future date: should show planning form
  </verify>
  <done>
- Modal opens in planning mode when pending plans exist
- Session review is secondary to planning
- User can still navigate to sessions via carousel
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Plan linking and modal hierarchy fixes</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Go to Journey tab
    3. Create a plan for today at a future time (e.g., 2:00 PM)
    4. Start and complete a short meditation session
    5. Verify: The 2:00 PM plan should NOT be marked as completed
    6. Click on today in calendar - modal should show the 2:00 PM plan first, not the session
    7. Verify "Session Details" is accessible by swiping in the carousel
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Plan linking respects time matching
- [ ] Modal opens in planning mode by default
</verification>

<success_criteria>

- Plan linking is time-aware (doesn't link morning plans to afternoon sessions)
- Modal shows planning interface first, session review second
- All existing tests pass
- No TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/09-journey-planner-fixes/09-01-SUMMARY.md`
</output>
