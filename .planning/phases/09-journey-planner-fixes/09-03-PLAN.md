---
phase: 09-journey-planner-fixes
plan: 03
type: execute
---

<objective>
Update NextSessionSpotlight and add "Add Pearl" (backfill) option to calendar modal.

Purpose:

1. Make hero card show upcoming plans for today even when sessions exist
2. Allow users to backfill session details after meditation (add pearl/notes to past session)

Output:

- NextSessionSpotlight finds and displays upcoming plans for today
- Calendar modal shows "Add a Pearl" option for days with sessions
  </objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-journey-planner-fixes/09-01-PLAN.md (depends on this)
@.planning/phases/09-journey-planner-fixes/09-02-PLAN.md (depends on this)

**Key files:**
@src/components/NextSessionSpotlight.tsx - Hero card showing next plan
@src/components/Journey/index.tsx - Loads next planned session
@src/lib/db/plans.ts - getNextPlannedSession() query
@src/components/MeditationPlanner/index.tsx - Modal UI

**User requirements:**

1. NextSessionSpotlight should show upcoming plan for TODAY even if a session was already completed
2. Calendar modal needs "Add a Pearl" option for backfilling session metadata
3. The hero card should update its state when a plan exists for upcoming time today
   </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix NextSessionSpotlight to find today's upcoming plans</name>
  <files>src/lib/db/plans.ts, src/components/Journey/index.tsx, src/components/NextSessionSpotlight.tsx</files>
  <action>
The current `getNextPlannedSession()` may skip plans for today if it uses simple date comparison. Fix this:

1. In `src/lib/db/plans.ts`, update `getNextPlannedSession()`:
   - For plans on today's date, check if `plannedTime` is in the future (or no time set)
   - Don't skip today just because a session was completed
   - Logic: Include plan if `plan.date >= todayStart` AND (`plan.plannedTime > currentTime` OR `!plan.plannedTime`)

2. In Journey/index.tsx `loadNextPlan()`:
   - Remove the `afterDate` parameter usage that was skipping today
   - Let `getNextPlannedSession()` handle the time-based filtering

3. In NextSessionSpotlight:
   - Add "Upcoming today" indicator when plan is for today
   - Ensure the component re-renders when plans change (it should via lastPlanChange dependency)

The hero should show "Today at 2:30 PM" style display when there's an upcoming plan for today.
</action>
<verify>

- Plan a session for today at a future time
- Complete a morning session
- NextSessionSpotlight should still show the afternoon plan
  </verify>
  <done>
- getNextPlannedSession() includes today's upcoming plans
- Hero card shows upcoming plans regardless of past sessions
- Time-based filtering works correctly
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add backfill option to MeditationPlanner modal</name>
  <files>src/components/MeditationPlanner/index.tsx</files>
  <action>
Add ability to "Add a Pearl" (backfill session details) when viewing past sessions:

1. In session mode (viewing completed session), add a button/link: "Add a Pearl" or "Add Session Details"
2. This should allow user to:
   - Add/edit notes (already exists via notes field)
   - Add intention (already exists)
   - Optionally create an insight entry (link to InsightCapture)

Actually, looking at the existing code, session mode already allows editing pose, discipline, and notes. The user's concern about "add a pearl option" may be about:

- Creating a NEW plan entry to document the session retroactively
- OR linking a pearl of wisdom to the session

For now, clarify the existing capability in the UI:

1. When in session mode, make it clearer that users CAN add/edit metadata
2. Add a subtle prompt: "Add details to remember this session"
3. Ensure the notes field is prominent with placeholder "Reflect on this session..."

If user meant "add pearl" as in attaching a Pearl from Pearls tab - that's for plans not sessions. Sessions capture Insights, not Pearls.
</action>
<verify>

- Open modal on a past day with sessions
- Session mode should clearly show editable fields for pose, discipline, notes
- Placeholder text should encourage reflection/backfill
  </verify>
  <done>
- Session mode UI clearly shows editable fields
- Users can backfill session metadata easily
- No confusion about what can be edited
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>NextSessionSpotlight fix and session backfill clarity</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Go to Journey tab
    3. Complete a meditation session (or if you have one from this morning, skip)
    4. Create a plan for today at a time in the future
    5. Check the hero "Your next meditation" card - it should show the upcoming plan
    6. Click on a past date in calendar that has a session
    7. Verify you can clearly see and edit: Position, Technique, Notes/Intention
    8. The interface should feel welcoming for adding session details after the fact
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] NextSessionSpotlight shows today's upcoming plans
- [ ] Session backfill is clear and accessible
- [ ] All tests pass
</verification>

<success_criteria>

- Hero card shows upcoming plans for today
- Session mode allows clear metadata backfill
- Time-based plan filtering works correctly
- Phase 09 delivers complete fix for dual-state planning issues
  </success_criteria>

<output>
After completion, create `.planning/phases/09-journey-planner-fixes/09-03-SUMMARY.md`
</output>
