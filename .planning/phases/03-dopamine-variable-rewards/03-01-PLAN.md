---
phase: 03-dopamine-variable-rewards
plan: 01
type: execute
---

<objective>
Add session count milestones and "first X this week" surprise rewards for dopamine variability.

Purpose: Introduce unpredictable micro-rewards between hour milestones to maintain dopamine engagement without addiction.
Output: Session count milestones, weekly "first" celebrations, near-miss visibility.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/lib/milestones.ts
@src/components/MilestoneCelebration.tsx
@src/lib/db.ts

**Existing milestone system:**
- Hour-based: 2h, 5h, 10h, then percentage-based
- Logarithmic scaling for "infinite mode"
- Brief celebrations (2.5s auto-dismiss)

**New variable rewards (from DOSE analysis):**
- Session count milestones: 50th session, 100th, etc.
- Weekly "firsts": First morning meditation this week
- Near-miss: "0.3 hours to next milestone"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session count milestones to milestones.ts</name>
  <files>src/lib/milestones.ts</files>
  <action>
Extend milestone system to include session counts:

```typescript
export type MilestoneType = 'hours' | 'sessions' | 'weekly_first'

export interface SessionMilestone {
  type: 'sessions'
  count: number
  label: string  // "50th session", "100th session"
}

// Session count milestones (surprise factor - less predictable than hours)
const SESSION_MILESTONES = [50, 100, 200, 365, 500, 1000, 2000, 5000, 10000]

export function checkSessionMilestone(sessionCount: number): SessionMilestone | null {
  if (SESSION_MILESTONES.includes(sessionCount)) {
    return {
      type: 'sessions',
      count: sessionCount,
      label: `${sessionCount}${getOrdinalSuffix(sessionCount)} session`
    }
  }
  return null
}

function getOrdinalSuffix(n: number): string {
  const s = ['th', 'st', 'nd', 'rd']
  const v = n % 100
  return s[(v - 20) % 10] || s[v] || s[0]
}
```

Keep separate from hour milestones - these are surprise rewards, not the main progression.
  </action>
  <verify>checkSessionMilestone returns correct milestone at 50, 100, etc.</verify>
  <done>Session count milestones defined</done>
</task>

<task type="auto">
  <name>Task 2: Add weekly "first" detection</name>
  <files>src/lib/milestones.ts</files>
  <action>
Add weekly first detection for variable rewards:

```typescript
export interface WeeklyFirstMilestone {
  type: 'weekly_first'
  kind: 'morning' | 'evening' | 'long_session' | 'new_discipline'
  label: string
}

const MORNING_START = 5   // 5am
const MORNING_END = 10    // 10am
const LONG_SESSION_THRESHOLD = 1800  // 30 minutes in seconds

export async function checkWeeklyFirsts(session: Session): Promise<WeeklyFirstMilestone | null> {
  const weekStart = getStartOfWeek(new Date())

  // Check if this is first morning session this week
  const hour = new Date(session.startTime).getHours()
  if (hour >= MORNING_START && hour < MORNING_END) {
    const morningSessions = await getSessionsInRange(weekStart, new Date(), {
      timeOfDay: 'morning'
    })
    if (morningSessions.length === 1) {  // This is the first (just completed)
      return {
        type: 'weekly_first',
        kind: 'morning',
        label: 'First morning meditation this week'
      }
    }
  }

  // Check if this is first long session this week
  if (session.durationSeconds >= LONG_SESSION_THRESHOLD) {
    const longSessions = await getSessionsInRange(weekStart, new Date(), {
      minDuration: LONG_SESSION_THRESHOLD
    })
    if (longSessions.length === 1) {
      return {
        type: 'weekly_first',
        kind: 'long_session',
        label: 'First 30+ minute session this week'
      }
    }
  }

  return null
}

function getStartOfWeek(date: Date): Date {
  const d = new Date(date)
  const day = d.getDay()
  const diff = d.getDate() - day + (day === 0 ? -6 : 1)  // Monday start
  d.setDate(diff)
  d.setHours(0, 0, 0, 0)
  return d
}
```

Variable rewards should feel surprising, not predictable.
  </action>
  <verify>Weekly first detection works for morning sessions</verify>
  <done>Weekly "first" milestones implemented</done>
</task>

<task type="auto">
  <name>Task 3: Update MilestoneCelebration for new types</name>
  <files>src/components/MilestoneCelebration.tsx</files>
  <action>
Extend celebration component to handle session and weekly_first types:

```typescript
// Update to accept different milestone types
interface MilestoneCelebrationProps {
  milestone: HourMilestone | SessionMilestone | WeeklyFirstMilestone | null
}

// Different messaging based on type:
const getZenMessage = (milestone) => {
  switch (milestone.type) {
    case 'hours':
      return 'The path continues.'
    case 'sessions':
      return 'Each moment matters.'
    case 'weekly_first':
      return 'A beautiful beginning.'
  }
}

// Same 2.5s auto-dismiss, same subtle celebration
```

Keep celebration brief and zen - no gamified language.
  </action>
  <verify>Celebrations work for all three milestone types</verify>
  <done>MilestoneCelebration handles all milestone types</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Session count milestones trigger at 50, 100, etc.
- [ ] Weekly first detection works for morning sessions
- [ ] Celebrations display appropriate messages
- [ ] Auto-dismiss works (2.5s)
</verification>

<success_criteria>

- All tasks completed
- Variable rewards add surprise factor
- Zen messaging maintained
- No addiction patterns introduced
</success_criteria>

<output>
After completion, create `.planning/phases/03-dopamine-variable-rewards/03-01-SUMMARY.md`
</output>
