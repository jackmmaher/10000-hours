---
phase: 03-dopamine-variable-rewards
plan: 02
type: execute
---

<objective>
Add near-miss visibility and progress anticipation UI states.

Purpose: Create anticipation tension when users are close to milestones, triggering dopamine through goal proximity.
Output: "Almost there" states in progress UI, near-miss notifications.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-dopamine-variable-rewards/03-01-SUMMARY.md
@src/lib/milestones.ts
@src/components/AchievementGallery.tsx
@src/components/Timer.tsx

**Goal Gradient Effect:**
Motivation increases as users approach their goal. When at 9.7 hours with 10h milestone,
showing "0.3 hours to milestone" creates anticipation that drives completion.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add near-miss detection to milestones.ts</name>
  <files>src/lib/milestones.ts</files>
  <action>
Add function to detect "almost there" states:

```typescript
export interface NearMissState {
  milestone: number | string  // Target milestone
  current: number            // Current value
  remaining: number          // How much left
  percentage: number         // How close (90%+ triggers near-miss)
  label: string              // "0.3 hours to 10h milestone"
}

const NEAR_MISS_THRESHOLD = 0.9  // 90% of the way there

export function checkNearMiss(
  currentHours: number,
  nextMilestone: number
): NearMissState | null {
  if (!nextMilestone) return null

  const percentage = currentHours / nextMilestone

  if (percentage >= NEAR_MISS_THRESHOLD && percentage < 1) {
    const remaining = nextMilestone - currentHours
    return {
      milestone: nextMilestone,
      current: currentHours,
      remaining: Math.round(remaining * 10) / 10,  // One decimal
      percentage,
      label: `${remaining.toFixed(1)} hours to ${nextMilestone}h milestone`
    }
  }

  return null
}

// For session count near-miss
export function checkSessionCountNearMiss(
  sessionCount: number
): NearMissState | null {
  // Find next session milestone
  const nextSessionMilestone = SESSION_MILESTONES.find(m => m > sessionCount)
  if (!nextSessionMilestone) return null

  const percentage = sessionCount / nextSessionMilestone

  if (percentage >= NEAR_MISS_THRESHOLD && percentage < 1) {
    const remaining = nextSessionMilestone - sessionCount
    return {
      milestone: nextSessionMilestone,
      current: sessionCount,
      remaining,
      percentage,
      label: `${remaining} sessions to ${nextSessionMilestone}th session`
    }
  }

  return null
}
```

Near-miss only triggers when 90%+ complete to avoid constant "almost there" fatigue.
  </action>
  <verify>Near-miss detects at 9.7/10 hours but not at 5/10 hours</verify>
  <done>Near-miss detection for hours and sessions</done>
</task>

<task type="auto">
  <name>Task 2: Add near-miss indicator to progress UI</name>
  <files>src/components/AchievementGallery.tsx</files>
  <action>
Show near-miss state in the achievement/progress area:

```tsx
import { checkNearMiss, checkSessionCountNearMiss } from '@/lib/milestones'

// In component, after getting current hours and next milestone:
const nearMiss = checkNearMiss(currentHours, nextMilestone)
const sessionNearMiss = checkSessionCountNearMiss(sessionCount)

// Render near-miss indicator when present:
{(nearMiss || sessionNearMiss) && (
  <div className="mt-2 px-3 py-2 bg-accent-muted rounded-lg">
    <p className="text-xs text-accent font-medium">
      âœ¨ {nearMiss?.label || sessionNearMiss?.label}
    </p>
  </div>
)}
```

Style to be encouraging, not urgent. Use accent color (theme-aware).
No countdown timers - just a gentle "you're close" message.
  </action>
  <verify>Near-miss indicator appears when within 10% of milestone</verify>
  <done>Near-miss visible in progress UI</done>
</task>

<task type="auto">
  <name>Task 3: Add anticipation pulse animation</name>
  <files>src/components/AchievementGallery.tsx, src/index.css</files>
  <action>
Add subtle pulse animation to the progress ring when in near-miss state:

```css
/* In index.css */
@keyframes nearMissPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.near-miss-pulse {
  animation: nearMissPulse 2s ease-in-out infinite;
}
```

Apply to progress ring or next milestone indicator when nearMiss is present.
Animation should be very subtle - a gentle "breathing" not a flashy pulse.
Respects prefers-reduced-motion.
  </action>
  <verify>Progress ring pulses gently when in near-miss state</verify>
  <done>Subtle anticipation animation added</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Near-miss detection and anticipation UI</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Go to Progress tab
    3. Check current hours - if not near a milestone, temporarily adjust
    4. When at 90%+ to a milestone, verify:
       - Near-miss message appears ("X hours to milestone")
       - Progress ring has subtle pulse animation
       - Message is encouraging, not urgent
    5. Complete a session to push past milestone
    6. Verify: Near-miss disappears, celebration appears
    7. Test with reduced motion setting - verify no animation
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Near-miss detects at 90%+ toward milestone
- [ ] UI shows encouraging "almost there" message
- [ ] Subtle pulse animation (respects reduced motion)
- [ ] No urgency language or guilt-inducing messaging
- [ ] Phase 03 complete
</verification>

<success_criteria>

- All tasks completed
- Goal gradient effect implemented
- Maintains zen philosophy (no pressure)
- Dopamine anticipation enhanced
</success_criteria>

<output>
After completion, create `.planning/phases/03-dopamine-variable-rewards/03-02-SUMMARY.md`
</output>
