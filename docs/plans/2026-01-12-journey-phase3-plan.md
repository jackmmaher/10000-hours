# Journey Tab Redesign - Phase 3: Recurring Sessions

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add ability to create recurring meditation sessions (daily, weekly, custom) that automatically generate planned sessions.

**Architecture:** Add RepeatRule table to IndexedDB. When user sets repeat on a plan, create a RepeatRule and generate concrete PlannedSession records for the next 4 weeks. Regenerate as needed.

**Tech Stack:** React, TypeScript, Dexie.js (IndexedDB), existing schema patterns

---

## Task 1: Add RepeatRule Type and Database Schema

**Files:**

- Modify: `src/lib/db/types.ts`
- Modify: `src/lib/db/schema.ts`

**Step 1: Add RepeatRule type to types.ts**

```typescript
export type RepeatFrequency = 'daily' | 'weekly' | 'weekdays' | 'custom'

export interface RepeatRule {
  id?: number
  createdAt: number

  // Schedule
  frequency: RepeatFrequency
  customDays?: number[] // 0-6 for Sun-Sat if custom
  endDate?: number // Optional end date timestamp

  // Session template
  plannedTime?: string // "HH:MM"
  duration?: number
  title?: string
  pose?: string
  discipline?: string
  notes?: string
  sourceTemplateId?: string
}
```

**Step 2: Add repeatRules table to schema.ts**

Bump version and add table:

```typescript
// In schema version upgrade
repeatRules: '++id, createdAt'
```

**Step 3: Add repeatRuleId to PlannedSession type**

```typescript
// In PlannedSession interface
repeatRuleId?: number // Link to repeat rule that generated this
```

**Step 4: Commit**

```bash
git commit -m "feat(db): add RepeatRule type and schema"
```

---

## Task 2: Add RepeatRule CRUD Functions

**Files:**

- Create: `src/lib/db/repeatRules.ts`
- Modify: `src/lib/db/index.ts` (export new functions)

**Step 1: Create repeatRules.ts with CRUD functions**

```typescript
import { db } from './schema'
import type { RepeatRule, PlannedSession } from './types'

export async function addRepeatRule(
  rule: Omit<RepeatRule, 'id' | 'createdAt'>
): Promise<RepeatRule> {
  const newRule: RepeatRule = {
    ...rule,
    createdAt: Date.now(),
  }
  const id = await db.repeatRules.add(newRule)
  return { ...newRule, id }
}

export async function getRepeatRule(id: number): Promise<RepeatRule | undefined> {
  return db.repeatRules.get(id)
}

export async function updateRepeatRule(id: number, updates: Partial<RepeatRule>): Promise<void> {
  await db.repeatRules.update(id, updates)
}

export async function deleteRepeatRule(id: number): Promise<void> {
  // Also delete all planned sessions generated by this rule
  await db.plannedSessions.where('repeatRuleId').equals(id).delete()
  await db.repeatRules.delete(id)
}

export async function getAllRepeatRules(): Promise<RepeatRule[]> {
  return db.repeatRules.toArray()
}
```

**Step 2: Add generateSessionsFromRule function**

```typescript
export async function generateSessionsFromRule(
  rule: RepeatRule,
  weeksAhead: number = 4
): Promise<PlannedSession[]> {
  const sessions: PlannedSession[] = []
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  const endDate = rule.endDate
    ? new Date(rule.endDate)
    : new Date(today.getTime() + weeksAhead * 7 * 24 * 60 * 60 * 1000)

  // Generate dates based on frequency
  const dates = getRepeatDates(rule.frequency, rule.customDays, today, endDate)

  for (const date of dates) {
    sessions.push({
      date: date.getTime(),
      plannedTime: rule.plannedTime,
      duration: rule.duration,
      title: rule.title,
      pose: rule.pose,
      discipline: rule.discipline,
      notes: rule.notes,
      sourceTemplateId: rule.sourceTemplateId,
      repeatRuleId: rule.id,
      createdAt: Date.now(),
    })
  }

  return sessions
}

function getRepeatDates(
  frequency: RepeatFrequency,
  customDays: number[] | undefined,
  start: Date,
  end: Date
): Date[] {
  const dates: Date[] = []
  const current = new Date(start)

  while (current <= end) {
    const dayOfWeek = current.getDay()
    let include = false

    switch (frequency) {
      case 'daily':
        include = true
        break
      case 'weekly':
        include = dayOfWeek === start.getDay()
        break
      case 'weekdays':
        include = dayOfWeek >= 1 && dayOfWeek <= 5
        break
      case 'custom':
        include = customDays?.includes(dayOfWeek) ?? false
        break
    }

    if (include) {
      dates.push(new Date(current))
    }

    current.setDate(current.getDate() + 1)
  }

  return dates
}
```

**Step 3: Export from index.ts**

**Step 4: Commit**

```bash
git commit -m "feat(db): add RepeatRule CRUD and session generation"
```

---

## Task 3: Add Repeat Picker UI to Planning Modal

**Files:**

- Create: `src/components/MeditationPlanner/RepeatPicker.tsx`
- Modify: `src/components/MeditationPlanner/usePlannerState.ts`
- Modify: `src/components/MeditationPlanner/index.tsx`

**Step 1: Create RepeatPicker component**

```typescript
interface RepeatPickerProps {
  value: RepeatFrequency | null
  customDays: number[]
  onChange: (frequency: RepeatFrequency | null, customDays?: number[]) => void
}

export function RepeatPicker({ value, customDays, onChange }: RepeatPickerProps) {
  // Render frequency options: Never, Daily, Weekly, Weekdays, Custom
  // If Custom selected, show day toggles (S M T W T F S)
}
```

**Step 2: Add repeat state to usePlannerState**

```typescript
const [repeatFrequency, setRepeatFrequency] = useState<RepeatFrequency | null>(null)
const [repeatCustomDays, setRepeatCustomDays] = useState<number[]>([])
```

**Step 3: Update handleSave to create repeat rule and sessions**

When saving with a repeat frequency:

1. Create RepeatRule
2. Generate PlannedSession records
3. Save all to database

**Step 4: Add RepeatPicker to planning form in index.tsx**

**Step 5: Commit**

```bash
git commit -m "feat(planner): add repeat picker for recurring sessions"
```

---

## Task 4: Handle Repeat Rule in Save Flow

**Files:**

- Modify: `src/components/MeditationPlanner/usePlannerState.ts`

**Step 1: Update handleSave**

```typescript
const handleSave = useCallback(async () => {
  // ... existing session mode handling

  if (!isSessionMode) {
    if (repeatFrequency) {
      // Create repeat rule
      const rule = await addRepeatRule({
        frequency: repeatFrequency,
        customDays: repeatFrequency === 'custom' ? repeatCustomDays : undefined,
        plannedTime: plannedTime || undefined,
        duration: duration || undefined,
        title: planTitle || undefined,
        pose: planPose || undefined,
        discipline: planDiscipline || undefined,
        notes: planNotes || undefined,
        sourceTemplateId: planSourceTemplateId,
      })

      // Generate sessions
      const sessions = await generateSessionsFromRule(rule)

      // Save all sessions
      for (const session of sessions) {
        await addPlannedSession(session)
      }
    } else {
      // Existing single plan save logic
    }
  }
}, [...])
```

**Step 2: Commit**

```bash
git commit -m "feat(planner): save recurring sessions to database"
```

---

## Task 5: Build and Test

**Step 1: Run build**

```bash
npm run build
```

**Step 2: Commit any fixes**

**Step 3: Push to GitHub**

```bash
git push origin main
```

---

## Summary

| File                                                  | Change                                 |
| ----------------------------------------------------- | -------------------------------------- |
| `src/lib/db/types.ts`                                 | ADD - RepeatRule type, RepeatFrequency |
| `src/lib/db/schema.ts`                                | MODIFY - Add repeatRules table         |
| `src/lib/db/repeatRules.ts`                           | NEW - CRUD and generation functions    |
| `src/lib/db/index.ts`                                 | MODIFY - Export new functions          |
| `src/components/MeditationPlanner/RepeatPicker.tsx`   | NEW - Frequency picker UI              |
| `src/components/MeditationPlanner/usePlannerState.ts` | MODIFY - Repeat state and save logic   |
| `src/components/MeditationPlanner/index.tsx`          | MODIFY - Add RepeatPicker to form      |
